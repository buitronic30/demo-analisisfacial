// 1. Variables globales (conectadas a tu HTML)
const video = document.getElementById('videoInput');
const captureBtn = document.getElementById('captureBtn');
let model = null;
let isLoading = false;

// 2. FunciÃ³n para INICIAR LA CÃMARA (optimizada para tablets)
async function startCamera() {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({
            video: {
                width: 320,  // ResoluciÃ³n baja para mejor rendimiento
                height: 240,
                facingMode: 'user'  // CÃ¡mara frontal
            }
        });
        video.srcObject = stream;
        video.play();  // Forzar reproducciÃ³n en algunos dispositivos
    } catch (err) {
        console.error("ðŸš¨ Error al activar la cÃ¡mara:", err);
        alert("No se pudo acceder a la cÃ¡mara. AsegÃºrate de dar permisos y usa Chrome/Firefox.");
    }
}

// 3. FunciÃ³n para CARGAR EL MODELO DE IA
async function loadModel() {
    try {
        isLoading = true;
        console.log("â³ Cargando modelo de IA...");
        
        // Modelo ligero para tablets (MediaPipe FaceMesh)
        model = await faceLandmarksDetection.load(
            faceLandmarksDetection.SupportedPackages.mediapipeFacemesh,
            { maxFaces: 1 }  // Solo detectar 1 rostro
        );
        
        console.log("âœ… Modelo cargado correctamente!");
        isLoading = false;
    } catch (err) {
        console.error("ðŸš¨ Error al cargar el modelo:", err);
        alert("La IA no pudo cargarse. Recarga la pÃ¡gina o usa otro dispositivo.");
        isLoading = false;
    }
}

// 4. FunciÃ³n para ANALIZAR EL ROSTRO
async function analyzeFace() {
    if (!model || isLoading) {
        alert("La IA aÃºn no estÃ¡ lista. Espera unos segundos.");
        return;
    }

    try {
        console.log("ðŸ” Analizando rostro...");
        const faces = await model.estimateFaces(video);
        
        if (faces.length > 0) {
            // Extraer datos clave para medicina estÃ©tica
            const landmarks = faces[0].scaledMesh;
            const wrinkles = calculateWrinkles(landmarks);  // FunciÃ³n personalizada
            const skinTone = getSkinTone(video);
            
            // Mostrar resultados (puedes personalizar esto)
            alert(`ðŸ“Š Resultados:\n- Arrugas: ${wrinkles}%\n- Tono de piel: ${skinTone}`);
        } else {
            alert("No se detectÃ³ ningÃºn rostro. AcÃ©rcate a la cÃ¡mara con buena luz.");
        }
    } catch (err) {
        console.error("ðŸš¨ Error al analizar:", err);
        alert("Error al procesar tu rostro. Intenta de nuevo.");
    }
}

// 5. Funciones auxiliares (personalÃ­zalas segÃºn necesites)
function calculateWrinkles(landmarks) {
    // LÃ³gica simplificada: contar puntos en zona de arrugas (frente)
    const forehead = landmarks.slice(10, 20);
    return Math.floor((forehead.length / 10) * 100);
}

function getSkinTone(videoElement) {
    // Ejemplo bÃ¡sico (puedes implementar algo mÃ¡s avanzado)
    return ["Claro", "Medio", "Oscuro"][Math.floor(Math.random() * 3)];
}

// 6. Eventos y InicializaciÃ³n
captureBtn.addEventListener('click', analyzeFace);

// Al cargar la pÃ¡gina:
document.addEventListener('DOMContentLoaded', async () => {
    await startCamera();
    await loadModel();
});
